<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
						http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
	<changeSet author="initial" id="20230707_10001">
		<sql dbms="postgresql">
			CREATE TABLE networks (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				CONSTRAINT networks_pk PRIMARY KEY (id),
				CONSTRAINT network_name_uk UNIQUE (name)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10002">
		<sql dbms="postgresql">
			CREATE TABLE deployment_types (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				CONSTRAINT deployment_types_pk PRIMARY KEY (id),
				CONSTRAINT deployment_type_name_uk UNIQUE (name)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10003">
		<sql dbms="postgresql">
			CREATE TABLE platforms (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				CONSTRAINT platforms_pk PRIMARY KEY (id),
				CONSTRAINT platform_name_uk UNIQUE (name)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10004">
		<sql dbms="postgresql">
			CREATE TABLE languages (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				CONSTRAINT languages_pk PRIMARY KEY (id),
				CONSTRAINT language_name_uk UNIQUE (name)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10005">
		<sql dbms="postgresql">
			CREATE TABLE architectures (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				CONSTRAINT architectures_pk PRIMARY KEY (id),
				CONSTRAINT architectures_name_type_uk UNIQUE (name)
			);
		</sql>
	</changeSet>	
	<changeSet author="initial" id="20230707_10006">
		<sql dbms="postgresql">
			CREATE TABLE companies (
				id int4 NOT NULL,
				name varchar NOT NULL,
				codes varchar NOT NULL,
				CONSTRAINT companies_pk PRIMARY KEY (id)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10007">
		<sql dbms="postgresql">
			CREATE TABLE metrics (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				type varchar NOT NULL,
				metric_value_type varchar NULL,
				metric_validation varchar NULL,
				CONSTRAINT metrics_pk PRIMARY KEY (id),
				CONSTRAINT metrics_name_type_uk UNIQUE (name,type)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10008">
		<sql dbms="postgresql">
			CREATE TABLE component_types (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				CONSTRAINT component_types_pk PRIMARY KEY (id),
				CONSTRAINT component_types_name_type_uk UNIQUE (name)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10009">
		<sql dbms="postgresql">
			CREATE TABLE uris (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				value varchar NOT NULL,
				type varchar NOT NULL,
				source varchar NULL,
				CONSTRAINT uris_pk PRIMARY KEY (id),
				CONSTRAINT uris_name_uk UNIQUE (name)
			);
		</sql>
	</changeSet>
			
	<changeSet author="initial" id="20230707_10010">
		<sql dbms="postgresql">
			CREATE TABLE departments (
				id int4 NOT NULL,
				name varchar NOT NULL,
				expiry_date timestamp,
				company_id int4 NOT NULL,
				CONSTRAINT departments_pk PRIMARY KEY (id),
				CONSTRAINT department_company_fk FOREIGN KEY (company_id) REFERENCES companies(id)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10011">
		<sql dbms="postgresql">
			CREATE TABLE component_type_architectures (
				id serial4 NOT NULL,
				component_type_id int4 NOT NULL,
				network_id int4 NOT NULL,
				deployment_type_id int4 NOT NULL,
				platform_id int4 NOT NULL,
				architecture_id int4 NOT NULL,
				language_id int4 NOT NULL,
				CONSTRAINT component_type_architectures_pk PRIMARY KEY (id),
				CONSTRAINT component_type_architectures_component_type_architecture_uk UNIQUE (component_type_id,network_id,deployment_type_id,platform_id,language_id,architecture_id),
				CONSTRAINT component_type_architecture_architecture_fk FOREIGN KEY (architecture_id) REFERENCES architectures(id),
				CONSTRAINT component_type_architecture_component_type_fk FOREIGN KEY (component_type_id) REFERENCES component_types(id),
				CONSTRAINT component_type_architecture_network_fk FOREIGN KEY (network_id) REFERENCES networks(id),
				CONSTRAINT component_type_architecture_deployment_type_fk FOREIGN KEY (deployment_type_id) REFERENCES deployment_types(id),
				CONSTRAINT component_type_architecture_platform_fk FOREIGN KEY (platform_id) REFERENCES platforms(id),
				CONSTRAINT component_type_architecture_language_fk FOREIGN KEY (language_id) REFERENCES languages(id)
			);
		</sql>
	</changeSet>
			
	<changeSet author="initial" id="20230707_10012">
		<sql dbms="postgresql">
			CREATE TABLE squads (
				id int4 NOT NULL,
				name varchar NOT NULL,
				coverage real,
				expiry_date timestamp,
				department_id int4 NOT NULL,
				CONSTRAINT squads_pk PRIMARY KEY (id),
				CONSTRAINT squads_department_fk FOREIGN KEY (department_id) REFERENCES departments(id) ON DELETE CASCADE
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10013">
		<sql dbms="postgresql">
			CREATE TABLE component_type_architecture_metrics (
				component_type_architecture_id int4 NOT NULL,
				metric_id int4 NOT NULL,
				CONSTRAINT component_type_architecture_metrics_pk PRIMARY KEY (metric_id, component_type_architecture_id),
				CONSTRAINT component_type_architecture_metric_metric_fk FOREIGN KEY (metric_id) REFERENCES metrics(id),
				CONSTRAINT component_type_architecture_metric_component_type_architecture_fk FOREIGN KEY (component_type_architecture_id) REFERENCES component_type_architectures(id) ON DELETE CASCADE
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10014">
		<sql dbms="postgresql">
			CREATE TABLE components (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				coverage real,
				expiry_date timestamp,
				component_type_architecture_id int4 NOT NULL,
				squad_id int4 NOT NULL,
				CONSTRAINT components_pk PRIMARY KEY (id),
				CONSTRAINT components_squad_component_name_uk UNIQUE (name,squad_id),
				CONSTRAINT component_component_type_architecture_fk FOREIGN KEY (component_type_architecture_id) REFERENCES component_type_architectures(id),
				CONSTRAINT component_squad_fk FOREIGN KEY (squad_id) REFERENCES squads(id)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10015">
		<sql dbms="postgresql">
			CREATE TABLE metric_values (
				id serial4 NOT NULL,
				metric_id int4 NOT NULL,
				component_type_architecture_id int4 NOT NULL,
				metric_value_date timestamp NOT NULL DEFAULT now(),
				metric_value_weight int4 NOT NULL DEFAULT 0,
				metric_expected_value varchar NOT NULL,
				metric_good_value varchar NULL,
				metric_perfect_value varchar NULL,
				CONSTRAINT metric_values_pk PRIMARY KEY (id),
				CONSTRAINT metric_value_metrics_fk FOREIGN KEY (metric_id) REFERENCES metrics(id) ON DELETE CASCADE ON UPDATE CASCADE,
				CONSTRAINT metric_value_component_type_architecture_fk FOREIGN KEY (component_type_architecture_id) REFERENCES component_type_architectures(id) ON DELETE CASCADE ON UPDATE CASCADE,
				CONSTRAINT metric_value_component_type_architecture_metrics_fk FOREIGN KEY (metric_id,component_type_architecture_id) REFERENCES component_type_architecture_metrics(metric_id,component_type_architecture_id) ON DELETE CASCADE ON UPDATE CASCADE
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10016">
		<sql dbms="postgresql">
			CREATE TABLE component_analysis (
				component_id int4 NOT NULL,
				analysis_date timestamp NOT NULL DEFAULT now(),
				metric_id int4 NOT NULL,
				component_type_architecture_id int4 NOT NULL,
				value varchar NULL,
				CONSTRAINT component_analysis_pk PRIMARY KEY (component_id,analysis_date,metric_id),
				CONSTRAINT component_analysis_component_fk FOREIGN KEY (component_id) REFERENCES components(id) ON DELETE CASCADE ON UPDATE CASCADE,
				CONSTRAINT component_analysis_component_type_architecture_metrics_fk FOREIGN KEY (metric_id,component_type_architecture_id) REFERENCES component_type_architecture_metrics(metric_id,component_type_architecture_id) ON DELETE CASCADE ON UPDATE CASCADE
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10017">
		<sql dbms="postgresql">
			CREATE TABLE component_properties (
				id serial4 NOT NULL,
				name varchar NOT NULL,
				value varchar NOT NULL,
				component_id int4 NOT NULL,
				CONSTRAINT poject_properties_pk PRIMARY KEY (id),
				CONSTRAINT poject_properties_uk UNIQUE (name, component_id),
				CONSTRAINT poject_property_component_fk FOREIGN KEY (component_id) REFERENCES components(id) ON DELETE CASCADE
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10018">
		<sql dbms="postgresql">
			CREATE TABLE component_uris (
				component_id int4 NOT NULL,
				uri_id int4 NOT NULL,
				CONSTRAINT component_uris_pk PRIMARY KEY (component_id, uri_id),
				CONSTRAINT component_uris_component_fk FOREIGN KEY (component_id) REFERENCES components(id) ON DELETE CASCADE ON UPDATE CASCADE,
				CONSTRAINT component_uris_uri_fk FOREIGN KEY (uri_id) REFERENCES uris(id)
			);
		</sql>
	</changeSet>		
	<changeSet author="initial" id="20230707_10019">
		<sql dbms="postgresql">
			CREATE TABLE request_properties (
				id serial4 NOT NULL,
				key varchar NOT NULL,
				value varchar NULL,
				CONSTRAINT request_properties_pk PRIMARY KEY (id)
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10020">
		<sql dbms="postgresql">
			CREATE TABLE uri_request_properties (
				uri_id int4 NOT NULL,
				request_property_id int4 NOT NULL,
				CONSTRAINT uri_request_properties_pk PRIMARY KEY (uri_id, request_property_id),
				CONSTRAINT uri_request_property_request_property_fk FOREIGN KEY (request_property_id) REFERENCES request_properties(id) ON DELETE CASCADE ON UPDATE CASCADE,
				CONSTRAINT uri_request_property_uri_fk FOREIGN KEY (uri_id) REFERENCES uris(id) ON DELETE CASCADE ON UPDATE CASCADE
			);
		</sql>
	</changeSet>
	<changeSet author="initial" id="20230707_10021">
		<sql dbms="postgresql">
			CREATE TABLE component_historical_coverages (
				component_id int4 NOT NULL,
				historical_coverage_date timestamp NOT NULL,
				historical_coverage_vaue real NOT NULL,
				CONSTRAINT component_historical_coverage_pk PRIMARY KEY (component_id, historical_coverage_date),
				CONSTRAINT component_historical_coverage_component_fk FOREIGN KEY (component_id) REFERENCES components(id) ON DELETE CASCADE ON UPDATE CASCADE
			);
		</sql>
	</changeSet>
</databaseChangeLog>
